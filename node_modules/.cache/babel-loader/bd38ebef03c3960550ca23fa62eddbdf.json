{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar jwt = require(\"jsonwebtoken\");\n\nvar common_1 = require(\"./common\");\n\nvar DEFAULT_TOKEN_EXPIRY = 24 * 60 * 60;\nvar CLIENT_CREDENTIALS_GRANT_TYPE = 'client_credentials';\nvar REFRESH_TOKEN_GRANT_TYPE = 'refresh_token';\n\nvar Authenticator =\n/** @class */\nfunction () {\n  function Authenticator(instanceId, instanceKeyId, instanceKeySecret, // Customise token expiry\n  tokenExpiry) {\n    this.instanceId = instanceId;\n    this.instanceKeyId = instanceKeyId;\n    this.instanceKeySecret = instanceKeySecret;\n    this.tokenExpiry = tokenExpiry;\n\n    if (!this.tokenExpiry) {\n      this.tokenExpiry = DEFAULT_TOKEN_EXPIRY;\n    }\n  }\n\n  Authenticator.prototype.authenticate = function (authenticatePayload, options) {\n    var grantType = authenticatePayload['grant_type'];\n\n    if (grantType !== CLIENT_CREDENTIALS_GRANT_TYPE) {\n      return new common_1.AuthenticationResponse({\n        status: 422,\n        body: {\n          error: 'token_provider/invalid_grant_type',\n          error_description: \"The grant_type provided, \" + grantType + \", is unsupported\"\n        }\n      });\n    }\n\n    return this.authenticateUsingClientCredentials(options);\n  };\n\n  Authenticator.prototype.authenticateWithRefreshToken = function (authenticatePayload, options) {\n    var grantType = authenticatePayload['grant_type'];\n\n    switch (grantType) {\n      case CLIENT_CREDENTIALS_GRANT_TYPE:\n        return this.authenticateUsingClientCredentials(options, true);\n\n      case REFRESH_TOKEN_GRANT_TYPE:\n        var oldRefreshToken = authenticatePayload[REFRESH_TOKEN_GRANT_TYPE];\n        return this.authenticateUsingRefreshToken(oldRefreshToken, options);\n\n      default:\n        return new common_1.AuthenticationResponse({\n          status: 422,\n          body: {\n            error: 'token_provider/invalid_grant_type',\n            error_description: \"The grant_type provided, \" + grantType + \", is unsupported\"\n          }\n        });\n    }\n  };\n\n  Authenticator.prototype.authenticateUsingClientCredentials = function (options, withRefreshToken) {\n    if (withRefreshToken === void 0) {\n      withRefreshToken = false;\n    }\n\n    var token = this.generateAccessToken(options).token;\n    var tokenExpiry = options.tokenExpiry || this.tokenExpiry;\n    var body = {\n      access_token: token,\n      expires_in: tokenExpiry,\n      token_type: 'bearer'\n    };\n\n    if (withRefreshToken) {\n      var refreshToken = this.generateRefreshToken(options);\n      body['refresh_token'] = refreshToken.token;\n    }\n\n    return new common_1.AuthenticationResponse({\n      status: 200,\n      body: body\n    });\n  };\n\n  Authenticator.prototype.authenticateUsingRefreshToken = function (oldRefreshToken, options) {\n    var decoded;\n    var tokenExpiry = options.tokenExpiry || this.tokenExpiry;\n\n    try {\n      decoded = jwt.verify(oldRefreshToken, this.instanceKeySecret, {\n        issuer: \"api_keys/\" + this.instanceKeyId\n      });\n    } catch (e) {\n      var description = e instanceof jwt.TokenExpiredError ? 'Refresh token has expired' : 'Refresh token is invalid';\n      return new common_1.AuthenticationResponse({\n        status: 401,\n        body: {\n          error: 'token_provider/invalid_refresh_token',\n          error_description: description\n        }\n      });\n    }\n\n    if (decoded.refresh !== true) {\n      return new common_1.AuthenticationResponse({\n        status: 401,\n        body: {\n          error: 'token_provider/invalid_refresh_token',\n          error_description: 'Refresh token does not have a refresh claim'\n        }\n      });\n    }\n\n    if (options.userId !== decoded.sub) {\n      return new common_1.AuthenticationResponse({\n        status: 401,\n        body: {\n          error: 'token_provider/invalid_refresh_token',\n          error_description: 'Refresh token has an invalid user id'\n        }\n      });\n    }\n\n    var newAccessToken = this.generateAccessToken(options);\n    var newRefreshToken = this.generateRefreshToken(options);\n    return new common_1.AuthenticationResponse({\n      status: 200,\n      body: {\n        access_token: newAccessToken.token,\n        token_type: 'bearer',\n        expires_in: tokenExpiry,\n        refresh_token: newRefreshToken.token\n      }\n    });\n  };\n\n  Authenticator.prototype.generateAccessToken = function (options) {\n    var now = Math.floor(Date.now() / 1000);\n    var tokenExpiry = options.tokenExpiry || this.tokenExpiry;\n\n    var claims = __assign({\n      instance: this.instanceId,\n      iss: \"api_keys/\" + this.instanceKeyId,\n      iat: now,\n      exp: now + tokenExpiry,\n      sub: options.userId,\n      su: options.su\n    }, options.serviceClaims);\n\n    return {\n      token: jwt.sign(claims, this.instanceKeySecret),\n      expires_in: tokenExpiry\n    };\n  };\n\n  Authenticator.prototype.generateRefreshToken = function (options) {\n    var now = Math.floor(Date.now() / 1000);\n    var claims = {\n      instance: this.instanceId,\n      iss: \"api_keys/\" + this.instanceKeyId,\n      iat: now,\n      refresh: true,\n      sub: options.userId\n    };\n    return {\n      token: jwt.sign(claims, this.instanceKeySecret)\n    };\n  };\n\n  return Authenticator;\n}();\n\nexports.default = Authenticator;","map":null,"metadata":{},"sourceType":"script"}